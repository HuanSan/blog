(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{351:function(s,a,t){"use strict";t.r(a);var n=t(10),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"使用docker安装gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用docker安装gitlab"}},[s._v("#")]),s._v(" 使用docker安装gitlab")]),s._v(" "),a("h2",{attrs:{id:"_1、安装gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、安装gitlab"}},[s._v("#")]),s._v(" 1、安装gitlab")]),s._v(" "),a("h3",{attrs:{id:"_1-1-创建gitlab数据目录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-创建gitlab数据目录"}},[s._v("#")]),s._v(" 1.1 创建gitlab数据目录")]),s._v(" "),a("p",[s._v("首先，需要为gitlab的数据创建一个目录，用来存储gitlab在运行过程中产生的数据。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sudo mkdir -p /data/gitlab  #/data/gitlab可以修改成合适的目录\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_1-2-搜索gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-搜索gitlab"}},[s._v("#")]),s._v(" 1.2 搜索gitlab")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("docker search gitlab\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_1-3-拉取gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-拉取gitlab"}},[s._v("#")]),s._v(" 1.3 拉取gitlab")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("docker pull gitlab/gitlab-ce\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_1-4-启动gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-启动gitlab"}},[s._v("#")]),s._v(" 1.4 启动gitlab")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("docker run -d -p 8099:80 -p 222:22 --name gitlabs --restart always -v /data/gitlab/etc:/etc/gitlab -v /data/gitlab/log:/var/log/gitlab -v /data/gitlab/data:/var/opt/gitlab gitlab/gitlab-ce\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("参数说明：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-i  以交互模式运行容器，通常与 -t 同时使用命令解释：\n\n-d  后台运行容器，并返回容器ID\n\n-p 8099:80  将容器内80端口映射至宿主机9980端口，这是访问gitlab的端口\n\n-p 222:22  将容器内22端口映射至宿主机222端口，这是访问ssh的端口\n\n-v ./gitlab/etc:/etc/gitlab  将容器/etc/gitlab目录挂载到宿主机./gitlab/etc目录下，若宿主机内此目录不存在将会自动创建，其他两个挂载同这个一样\n\n--restart always  容器自启动\n\n--privileged=true  让容器获取宿主机root权限\n\n--name gitlab-test  设置容器名称为gitlab\n\ngitlab/gitlab-ce  镜像的名称，这里也可以写镜像ID\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("h2",{attrs:{id:"_2、配置gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、配置gitlab"}},[s._v("#")]),s._v(" 2、配置gitlab")]),s._v(" "),a("h3",{attrs:{id:"_2-1-修改配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-修改配置文件"}},[s._v("#")]),s._v(" 2.1 修改配置文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vim /data/gitlab/etc/gitlab.rb\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("或者进入容器再修改：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sudo docker exec -it gitlabs /bin/bash\nvim /etc/gitlab/gitlab.rb\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("external_url 'http://服务器ip:端口/'\ngitlab_rails['gitlab_ssh_host'] = '服务器ip'\ngitlab_rails['gitlab_shell_ssh_port'] = 222\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("若不配置则默认 80 端口 和 22 端口(ssh)，本人使用了端口映射所以默认不配置，只需要服务器开放8099和222端口。")]),s._v(" "),a("p",[s._v("改完配置后需要重载配置")]),s._v(" "),a("h3",{attrs:{id:"_2-2-修改密码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-修改密码"}},[s._v("#")]),s._v(" 2.2 修改密码")]),s._v(" "),a("p",[s._v("查看初始密码：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vim /data/gitlab/etc/initial_root_password\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("或者进入容器查看：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sudo docker exec -it gitlabs /bin/bash\nvim /etc/gitlab/initial_root_password\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("进入gitlab网站，使用 root 账号和初始密码登录，然后再修改密码")]),s._v(" "),a("p",[s._v("第二种办法：")]),s._v(" "),a("p",[s._v("（本人使用该方法未通过，在执行 "),a("code",[s._v("gitlab-rails console -e production")]),s._v(" 或者 "),a("code",[s._v("gitlab-rails console")]),s._v(" 都直接卡死在页面上）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 进入容器内部\ndocker exec -it gitlab /bin/bash\n \n# 进入控制台\ngitlab-rails console -e production\n \n# 查询id为1的用户，id为1的用户是超级管理员\nuser = User.where(id:1).first\n# 修改密码为root1AQ@\nuser.password='root1AQ@'\n# 保存\nuser.save!\n# 退出\nexit\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("h2",{attrs:{id:"_3、设置邮箱"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、设置邮箱"}},[s._v("#")]),s._v(" 3、设置邮箱")]),s._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("gitlab_rails['smtp_enable'] = true\ngitlab_rails['smtp_address'] = \"smtp.qq.com\"\ngitlab_rails['smtp_port'] = 465\ngitlab_rails['smtp_user_name'] = \"xxx@qq.com\"\ngitlab_rails['smtp_password'] = \"hlldwcjoqsc******\"\ngitlab_rails['smtp_authentication'] = \"login\"\ngitlab_rails['smtp_enable_starttls_auto'] = true\ngitlab_rails['smtp_tls'] = true\ngitlab_rails['gitlab_email_from'] = 'xxx@qq.com'\ngitlab_rails['smtp_domain'] = \"qq.com\"\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h2",{attrs:{id:"_4、轻量化运行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4、轻量化运行"}},[s._v("#")]),s._v(" 4、轻量化运行")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 关闭容器仓库功能\ngitlab_rails['gitlab_default_projects_features_container_registry'] = false\ngitlab_rails['registry_enabled'] = false\nregistry['enable'] = false\nregistry_nginx['enable'] = false\n\n# 包仓库、依赖管理\ngitlab_rails['packages_enabled'] = false\ngitlab_rails['dependency_proxy_enabled'] = false\n\n# GitLab Pages\ngitlab_pages['enable'] = false\npages_nginx['enable'] = false\n\n# 关闭监控和性能基准相关功能\nprometheus_monitoring['enable'] = false\nalertmanager['enable'] = false\nnode_exporter['enable'] = false\nredis_exporter['enable'] = false\npostgres_exporter['enable'] = false\npgbouncer_exporter['enable'] = false\ngitlab_exporter['enable'] = false\ngrafana['enable'] = false\nsidekiq['metrics_enabled'] = false\n\n# 针对应用的性能分析和上报\ngitlab_rails['usage_ping_enabled'] = false\ngitlab_rails['sentry_enabled'] = false\ngrafana['reporting_enabled'] = false\n\n# GitLab KAS\ngitlab_kas['enable'] = false\ngitlab_rails['gitlab_kas_enabled'] = false\n# Terraform\ngitlab_rails['terraform_state_enabled'] = false\n# Kerberos 文档说EE only，但是默认值为 true\ngitlab_rails['kerberos_enabled'] = false\n# Sentinel\nsentinel['enable'] = false\n# Mattermost\nmattermost['enable'] = false\nmattermost_nginx['enable'] = false\n\n# 禁用 PUMA 集群模式\npuma['worker_processes'] = 0\npuma['min_threads'] = 1\npuma['max_threads'] = 2\n\n# 降低后台守护进程并发数\nsidekiq['max_concurrency'] = 5\n\n# 关闭电子邮件相关功能\ngitlab_rails['smtp_enable'] = false\ngitlab_rails['gitlab_email_enabled'] = false\ngitlab_rails['incoming_email_enabled'] = false\n\n# 关闭ci\ngitlab_ci['gitlab_ci_all_broken_builds'] = false\ngitlab_ci['gitlab_ci_add_pusher'] = false\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br")])]),a("h2",{attrs:{id:"_5、容器命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5、容器命令"}},[s._v("#")]),s._v(" 5、容器命令")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" restart gitlab "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启容器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" gitlab "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除容器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 退出容器")]),s._v("\n\ngitlab-ctl start "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动全部服务")]),s._v("\ngitlab-ctl restart "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启全部服务")]),s._v("\ngitlab-ctl stop "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#停止全部服务")]),s._v("\ngitlab-ctl restart nginx "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#重启单个服务，如重启nginx")]),s._v("\ngitlab-ctl status "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看服务状态")]),s._v("\ngitlab-ctl reconfigure "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#使配置文件生效")]),s._v("\ngitlab-ctl show-config "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#验证配置文件")]),s._v("\n\ngitlab-ctl uninstall "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#删除gitlab（保留数据）")]),s._v("\ngitlab-ctl cleanse "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#删除所有数据，从新开始")]),s._v("\ngitlab-ctl "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("service name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("查看服务的日志\ngitlab-ctl "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" nginx  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#如查看gitlab下nginx日志")]),s._v("\ngitlab-rails console  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#进入控制台")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# gitlab 数据目录")]),s._v("\n/var/opt/gitlab\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 命令目录")]),s._v("\n/opt/gitlab/bin\ngitlab-backup  gitlab-healthcheck  gitlab-rails  gitlab-redis-cli\ngitlab-ctl     gitlab-psql         gitlab-rake   gitlab-ruby\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("h2",{attrs:{id:"_6、参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6、参考"}},[s._v("#")]),s._v(" 6、参考")]),s._v(" "),a("p",[s._v("https://zhuanlan.zhihu.com/p/413217715")]),s._v(" "),a("h2",{attrs:{id:"_7、常见错误及操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7、常见错误及操作"}},[s._v("#")]),s._v(" 7、常见错误及操作")]),s._v(" "),a("h3",{attrs:{id:"_7-1-postgresql-数据库启动失败引起的-502-页面异常"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-postgresql-数据库启动失败引起的-502-页面异常"}},[s._v("#")]),s._v(" 7.1 postgresql 数据库启动失败引起的 502 页面异常")]),s._v(" "),a("p",[s._v("（1）查看服务状态")]),s._v(" "),a("p",[s._v("进入容器 "),a("code",[s._v("sudo docker exec -it gitlabs /bin/bash")]),s._v(" 后查看服务状态 "),a("code",[s._v("gitlab-ctl status")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("run: gitaly: (pid 278) 90s; run: log: (pid 276) 90s\nrun: gitlab-workhorse: (pid 338) 88s; run: log: (pid 336) 88s\nrun: logrotate: (pid 277) 90s; run: log: (pid 275) 90s\nrun: nginx: (pid 339) 88s; run: log: (pid 337) 88s\ndown: postgresql: 1s, normally up, want up; run: log: (pid 334) 88s\nrun: puma: (pid 551) 13s; run: log: (pid 331) 88s\nrun: redis: (pid 280) 90s; run: log: (pid 279) 90s\nrun: sidekiq: (pid 560) 10s; run: log: (pid 330) 88s\nrun: sshd: (pid 38) 101s; run: log: (pid 33) 101s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("可以看到 "),a("code",[s._v("postgresql")]),s._v(" 服务是 "),a("code",[s._v("down")]),s._v(" 的状态")]),s._v(" "),a("p",[s._v("（2）查看服务日志")]),s._v(" "),a("p",[s._v("输入命令 "),a("code",[s._v("gitlab-ctl tail postgresql")]),s._v("，提示：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('database system is shut down\n2023-10-25_10:22:35.73532 LOG:  starting PostgreSQL 13.11 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 11.3.0-1ubuntu1~22.04.1) 11.3.0, 64-bit\n2023-10-25_10:22:35.73535 FATAL:  lock file "/var/opt/gitlab/postgresql/.s.PGSQL.5432.lock" is empty\n2023-10-25_10:22:35.73535 HINT:  Either another server is starting, or the lock file is the remnant of a previous server startup crash.\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("（3）删除遗留的 lock 和 pid 文件")]),s._v(" "),a("p",[s._v("进入容器找到 "),a("code",[s._v("/var/opt/gitlab/postgresql/.s.PGSQL.5432.lock")]),s._v(" 文件并删除")]),s._v(" "),a("p",[s._v("重启服务，然后出现提示：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('lock file "postmaster.pid" is empty\n2023-10-25_09:17:25.83247 HINT:  Either another server is starting, or the lock file is the remnant of a previous server startup crash.\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("在 "),a("code",[s._v("/var/opt/gitlab/postgresql/data")]),s._v(" 目录下找到 "),a("code",[s._v("postmaster.pid")]),s._v(" 文件并删除")]),s._v(" "),a("p",[s._v("重启服务，然后出现提示：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("database system was shut down at 2023-09-27 14:22:07 GMT\n2023-10-25_10:31:52.16432 LOG:  invalid record length at 0/6B355F0: wanted 24, got 0\n2023-10-25_10:31:52.16440 LOG:  invalid primary checkpoint record\n2023-10-25_10:31:52.16447 PANIC:  could not locate a valid checkpoint record\n2023-10-25_10:31:52.49977 LOG:  startup process (PID 394) was terminated by signal 6: Aborted\n2023-10-25_10:31:52.49979 LOG:  aborting startup due to startup process failure\n2023-10-25_10:31:52.49980 LOG:  database system is shut down\n2023-10-25_10:31:53.63088 LOG:  starting PostgreSQL 13.11 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 11.3.0-1ubuntu1~22.04.1) 11.3.0, 64-bit\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("使用命令修复：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Postgres >= 10")]),s._v("\npg_resetwal /var/opt/gitlab/postgresql/data\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Postgres < 10")]),s._v("\npg_resetxlog /var/opt/gitlab/postgresql/data\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可能会提示需要使用 Postgres 超级管理员的权限来使用该命令，进入 Postgres 超级管理员用户权限")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - gitlab-psql "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用户名可以通过进入 /var/opt/gitlab/postgresql/data 目录，使用 ll 命令查看")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 然后输入命令")]),s._v("\npg_resetwal /var/opt/gitlab/postgresql/data\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 强制更新")]),s._v("\npg_resetwal "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" /var/opt/gitlab/postgresql/data\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h3",{attrs:{id:"_7-2-使用命令行修改普通用户为管理员"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-使用命令行修改普通用户为管理员"}},[s._v("#")]),s._v(" 7.2 使用命令行修改普通用户为管理员")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /var/opt/gitlab/gitlab-rails/etc/database.yml\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - gitlab-psql\n\npsql "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-h")]),s._v(" /var/opt/gitlab/postgresql "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" gitlabhq_production\n$ "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" id,username,email,admin from "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("users")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" id,username,email,admin from "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("users")]),s._v(" where "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sanyer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n$ update "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("users")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("admin")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'t'")]),s._v(" where "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sanyer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 出现 UPDATE 1 则修改成功")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);